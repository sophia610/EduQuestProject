@page "/quiz-details/{QuizId:int}"
@using DBL
@using Models
@inject NavigationManager nav
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage session

<PageTitle>Quiz Details | EduQuest</PageTitle>

<style>
    body {
        margin: 0;
        background: #f5f7fa;
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    .page-container {
        min-height: 100vh;
        background: #f5f7fa;
    }

    .top-nav {
        background: white;
        padding: 16px 32px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .back-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: none;
        border: none;
        color: #3b82f6;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.2s;
    }

        .back-btn:hover {
            background: #eff6ff;
        }

    .nav-actions {
        display: flex;
        gap: 12px;
    }

    .btn-stats {
        background: #f0fdf4;
        color: #16a34a;
    }

        .btn-stats:hover {
            background: #dcfce7;
        }

    .action-btn {
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-edit {
        background: #eff6ff;
        color: #3b82f6;
    }

        .btn-edit:hover {
            background: #dbeafe;
        }

    .btn-delete {
        background: #fef2f2;
        color: #dc2626;
    }

        .btn-delete:hover {
            background: #fee2e2;
        }

    .content-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 32px;
    }

    .quiz-header {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 20px;
        padding: 40px;
        color: white;
        margin-bottom: 32px;
        position: relative;
        overflow: hidden;
    }

        .quiz-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

    .quiz-title {
        font-size: 32px;
        font-weight: 700;
        margin: 0 0 12px 0;
        position: relative;
    }

    .quiz-description {
        font-size: 16px;
        opacity: 0.95;
        margin: 0 0 24px 0;
        position: relative;
    }

    .quiz-meta-row {
        display: flex;
        gap: 24px;
        position: relative;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
        background: rgba(255,255,255,0.2);
        padding: 8px 16px;
        border-radius: 10px;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-box {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        text-align: center;
    }

    .stat-icon {
        font-size: 32px;
        margin-bottom: 12px;
    }

    .stat-number {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
    }

    .section {
        background: white;
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        margin-bottom: 24px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .add-question-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

        .add-question-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

    .questions-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .question-card {
        border: 2px solid #e5e7eb;
        border-radius: 14px;
        padding: 24px;
        transition: all 0.2s;
    }

        .question-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 16px;
    }

    .question-number {
        background: #eff6ff;
        color: #3b82f6;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 700;
    }

    .question-actions {
        display: flex;
        gap: 8px;
    }

    .icon-btn {
        background: #f3f4f6;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s;
    }

        .icon-btn:hover {
            transform: scale(1.1);
        }

        .icon-btn.edit:hover {
            background: #dbeafe;
            color: #3b82f6;
        }

        .icon-btn.delete:hover {
            background: #fee2e2;
            color: #dc2626;
        }

    .question-text {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
        line-height: 1.6;
    }

    .answers-grid {
        display: grid;
        gap: 12px;
    }

    .answer-item {
        display: flex;
        align-items: start;
        gap: 12px;
        padding: 14px;
        background: #f9fafb;
        border-radius: 10px;
        border: 2px solid transparent;
        transition: all 0.2s;
    }

        .answer-item.correct {
            background: #f0fdf4;
            border-color: #86efac;
        }

    .answer-icon {
        font-size: 20px;
        margin-top: 2px;
    }

    .answer-text {
        flex: 1;
        font-size: 15px;
        color: #374151;
        line-height: 1.5;
    }

    .hint-box {
        margin-top: 12px;
        padding: 12px 16px;
        background: #fffbeb;
        border-left: 4px solid #fbbf24;
        border-radius: 8px;
    }

    .hint-label {
        font-size: 12px;
        font-weight: 700;
        color: #f59e0b;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .hint-text {
        font-size: 14px;
        color: #92400e;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
    }

    .empty-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 20px;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 8px;
    }

    .empty-text {
        font-size: 15px;
        margin-bottom: 24px;
    }

    .loading-state {
        text-align: center;
        padding: 60px 20px;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal {
        background: white;
        border-radius: 20px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
        margin: 0 0 16px 0;
    }

    .modal-text {
        font-size: 15px;
        color: #6b7280;
        margin-bottom: 24px;
        line-height: 1.6;
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-cancel {
        background: #f3f4f6;
        color: #374151;
    }

        .btn-cancel:hover {
            background: #e5e7eb;
        }

    .btn-confirm {
        background: #dc2626;
        color: white;
    }

        .btn-confirm:hover {
            background: #b91c1c;
        }
</style>

<div class="page-container">
    <div class="top-nav">
        <button class="back-btn" @onclick="GoBack">
            <span>←</span>
            <span>Back to Dashboard</span>
        </button>
        <div class="nav-actions">
            <button class="action-btn btn-stats" @onclick="ViewStatistics">
                <span>📊</span>
                <span>View Statistics</span>
            </button>
            <button class="action-btn btn-edit" @onclick="EditQuiz">
                <span>✏️</span>
                <span>Edit Quiz</span>
            </button>
            <button class="action-btn btn-delete" @onclick="ShowDeleteModal">
                <span>🗑️</span>
                <span>Delete</span>
            </button>
        </div>
    </div>

    <div class="content-wrapper">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading quiz details...</p>
            </div>
        }
        else if (quiz == null)
        {
            <div class="empty-state">
                <div class="empty-icon">❌</div>
                <div class="empty-title">Quiz not found</div>
                <p class="empty-text">The quiz you're looking for doesn't exist.</p>
            </div>
        }
        else
        {
            <div class="quiz-header">
                <h1 class="quiz-title">@quiz.QuizName</h1>
                <p class="quiz-description">@quiz.Description</p>
                <div class="quiz-meta-row">
                    <div class="meta-item">
                        <span>📅</span>
                        <span>Created @quiz.CreatedAt.ToString("dd MMM yyyy")</span>
                    </div>
                    <div class="meta-item">
                        <span>📝</span>
                        <span>@(quiz.Questions?.Count ?? 0) Questions</span>
                    </div>
                    <div class="meta-item">
                        <span>@(quiz.IsActive ? "🟢" : "🔴")</span>
                        <span>@(quiz.IsActive ? "Active" : "Inactive")</span>
                    </div>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-icon">📝</div>
                    <div class="stat-number">@(quiz.Questions?.Count ?? 0)</div>
                    <div class="stat-label">Total Questions</div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">👥</div>
                    <div class="stat-number">@studentsAttempted</div>
                    <div class="stat-label">Students Attempted</div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">✓</div>
                    <div class="stat-number">@studentsCompleted</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">⭐</div>
                    <div class="stat-number">@averageScore%</div>
                    <div class="stat-label">Avg Score</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>📋</span>
                        <span>Quiz Questions</span>
                    </h2>
                    <button class="add-question-btn" @onclick="AddQuestion">
                        <span>➕</span>
                        <span>Add Question</span>
                    </button>
                </div>

                @if (quiz.Questions == null || quiz.Questions.Count == 0)
                {
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <div class="empty-title">No questions yet</div>
                        <p class="empty-text">Start building your quiz by adding questions!</p>
                        <button class="add-question-btn" @onclick="AddQuestion">
                            <span>➕</span>
                            <span>Add First Question</span>
                        </button>
                    </div>
                }
                else
                {
                    <div class="questions-list">
                        @for (int i = 0; i < quiz.Questions.Count; i++)
                        {
                            var question = quiz.Questions[i];
                            var questionIndex = i + 1;
                            <div class="question-card">
                                <div class="question-header">
                                    <span class="question-number">Question @questionIndex</span>
                                    <div class="question-actions">
                                        <button class="icon-btn edit" @onclick="@(() => EditQuestion(question.QuestionID))">
                                            ✏️
                                        </button>
                                        <button class="icon-btn delete" @onclick="@(() => ShowDeleteQuestionModal(question.QuestionID))">
                                            🗑️
                                        </button>
                                    </div>
                                </div>

                                <div class="question-text">@question.QuestionText</div>

                                @if (question.Answers != null && question.Answers.Count > 0)
                                {
                                    <div class="answers-grid">
                                        @foreach (var answer in question.Answers)
                                        {
                                            <div class="answer-item @(answer.IsCorrect ? "correct" : "")">
                                                <span class="answer-icon">@(answer.IsCorrect ? "✅" : "⭕")</span>
                                                <span class="answer-text">@answer.AnswerText</span>
                                            </div>
                                        }
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(question.Hint))
                                {
                                    <div class="hint-box">
                                        <div class="hint-label">💡 Hint</div>
                                        <div class="hint-text">@question.Hint</div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

@if (showDeleteModal)
{
    <div class="modal-overlay" @onclick="HideDeleteModal">
        <div class="modal" @onclick:stopPropagation="true">
            <h2 class="modal-title">Delete Quiz?</h2>
            <p class="modal-text">
                Are you sure you want to delete this quiz? This action cannot be undone and will remove all questions and student progress.
            </p>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" @onclick="HideDeleteModal">Cancel</button>
                <button class="modal-btn btn-confirm" @onclick="ConfirmDelete">Delete Quiz</button>
            </div>
        </div>
    </div>
}

@if (showDeleteQuestionModal)
{
    <div class="modal-overlay" @onclick="HideDeleteQuestionModal">
        <div class="modal" @onclick:stopPropagation="true">
            <h2 class="modal-title">Delete Question?</h2>
            <p class="modal-text">
                Are you sure you want to delete this question? This action cannot be undone.
            </p>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" @onclick="HideDeleteQuestionModal">Cancel</button>
                <button class="modal-btn btn-confirm" @onclick="ConfirmDeleteQuestion">Delete Question</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int QuizId { get; set; }

    private Quiz quiz;
    private bool isLoading = true;
    private bool showDeleteModal = false;
    private bool showDeleteQuestionModal = false;
    private int questionToDelete = 0;
    private bool accessDenied = false;
    private int currentTeacherId = 0;
    private int studentsAttempted = 0;
    private int studentsCompleted = 0;
    private int averageScore = 0;

    protected override async Task OnInitializedAsync()
    {
        var result = await session.GetAsync<Customers>("user");
        if (!result.Success || result.Value == null)
        {
            nav.NavigateTo("/login");
            return;
        }

        var currentUser = result.Value;
        if (currentUser.Role != 1)
        {
            nav.NavigateTo("/student-home");
            return;
        }

        currentTeacherId = currentUser.user_id;
        await LoadQuizAsync();
    }

    private async Task LoadQuizAsync()
    {
        try
        {
            isLoading = true;
            var db = new QuizDB();
            quiz = await db.GetQuizWithQuestionsAsync(QuizId);
            if (quiz != null)
            {
                if (quiz.TeacherId != currentTeacherId)
                {
                    accessDenied = true;
                    isLoading = false;
                    return;
                }
                await LoadStatisticsAsync();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading quiz: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
    private async Task LoadStatisticsAsync()
    {
        try
        {
            var resultDb = new ResultDB();
            var allResults = await resultDb.GetAllQuizResultsAsync(QuizId);

            if (allResults.Count > 0)
            {
                // כמה תלמידים התחילו
                studentsAttempted = allResults.Select(r => r.student_id).Distinct().Count();

                // כמה תלמידים סיימו (יש להם score > 0)
                studentsCompleted = allResults.Where(r => r.score > 0)
                                              .Select(r => r.student_id)
                                              .Distinct()
                                              .Count();

                // ציון ממוצע (רק של מי שסיים)
                var completedScores = allResults.Where(r => r.score > 0)
                                                .GroupBy(r => r.student_id)
                                                .Select(g => g.First().score)
                                                .ToList();

                averageScore = completedScores.Count > 0 ? (int)completedScores.Average() : 0;
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading statistics: {ex.Message}");
        }
    }
    private void GoBack()
    {
        nav.NavigateTo("/teacher-home");
    }

    private void EditQuiz()
    {
        nav.NavigateTo($"/edit-quiz/{QuizId}");
    }

    private void AddQuestion()
    {
        nav.NavigateTo($"/add-question/{QuizId}");
    }

    private void EditQuestion(int questionId)
    {
        nav.NavigateTo($"/edit-question/{questionId}");
    }

    private void ShowDeleteModal()
    {
        showDeleteModal = true;
    }

    private void HideDeleteModal()
    {
        showDeleteModal = false;
    }

    private void ShowDeleteQuestionModal(int questionId)
    {
        questionToDelete = questionId;
        showDeleteQuestionModal = true;
    }

    private void HideDeleteQuestionModal()
    {
        showDeleteQuestionModal = false;
        questionToDelete = 0;
    }

    private async Task ConfirmDelete()
    {
        try
        {
            var db = new QuizDB();
            await db.DeleteQuizAsync(QuizId);
            nav.NavigateTo("/teacher-home");
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error deleting quiz: {ex.Message}");
        }
    }

    private async Task ConfirmDeleteQuestion()
    {
        try
        {
            var db = new QuestionDB();
            await db.DeleteQuestionAsync(questionToDelete);
            HideDeleteQuestionModal();
            await LoadQuizAsync(); 
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error deleting question: {ex.Message}");
        }
    }

    private int GetRandomNumber(int min, int max)
    {
        var random = new Random();
        return random.Next(min, max + 1);
    }
    private void ViewStatistics()
    {
        nav.NavigateTo($"/quiz-statistics/{QuizId}");
    }
}