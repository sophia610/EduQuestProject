@page "/take-quiz/{QuizId:int}"
@using DBL
@using Models
@inject NavigationManager nav
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage session

<PageTitle>Take Quiz | EduQuest</PageTitle>

<style>
    body {
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        overflow-x: hidden;
    }

    .quiz-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        position: relative;
    }

    .background-decoration {
        position: fixed;
        width: 300px;
        height: 300px;
        border-radius: 50%;
        opacity: 0.1;
        pointer-events: none;
    }

    .decoration-1 {
        top: -100px;
        right: -100px;
        background: white;
    }

    .decoration-2 {
        bottom: -100px;
        left: -100px;
        background: white;
    }

    .quiz-card {
        background: white;
        border-radius: 24px;
        max-width: 800px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
    }

    .quiz-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 32px 40px;
        position: relative;
    }

    .quiz-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .quiz-title {
        font-size: 28px;
        font-weight: 700;
        margin: 0;
    }

    .quiz-progress {
        background: rgba(255,255,255,0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }

    .progress-bar-container {
        height: 6px;
        background: rgba(255,255,255,0.2);
        margin-top: 20px;
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: white;
        border-radius: 3px;
        transition: width 0.4s ease;
    }

    .setup-screen {
        padding: 60px 40px;
        text-align: center;
    }

    .setup-icon {
        font-size: 80px;
        margin-bottom: 24px;
        animation: bounce 2s infinite;
    }

    @@keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-20px); }
    }

    .setup-title {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 12px;
    }

    .setup-description {
        font-size: 16px;
        color: #6b7280;
        margin-bottom: 40px;
        line-height: 1.6;
    }

    .quiz-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 40px;
    }

    .info-box {
        background: #f9fafb;
        border-radius: 16px;
        padding: 24px;
        text-align: center;
    }

    .info-icon {
        font-size: 32px;
        margin-bottom: 12px;
    }

    .info-value {
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .info-label {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
    }

    .question-selector {
        margin-bottom: 40px;
    }

    .selector-label {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 12px;
        text-align: left;
    }

    .slider-container {
        padding: 20px;
        background: #f9fafb;
        border-radius: 16px;
    }

    .slider {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #e5e7eb;
        outline: none;
        -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .slider-value {
        text-align: center;
        font-size: 32px;
        font-weight: 700;
        color: #667eea;
        margin-top: 16px;
    }

    .start-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 18px 48px;
        border-radius: 14px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .start-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 28px rgba(102, 126, 234, 0.5);
    }

    .question-screen {
        padding: 60px 40px;
        min-height: 500px;
        display: flex;
        flex-direction: column;
    }

    .question-number {
        font-size: 14px;
        font-weight: 700;
        color: #667eea;
        text-transform: uppercase;
        margin-bottom: 16px;
    }

    .question-text {
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 32px;
        line-height: 1.4;
    }

    .answers-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 32px;
        flex: 1;
    }

    .answer-option {
        background: #f9fafb;
        border: 3px solid #e5e7eb;
        border-radius: 16px;
        padding: 20px 24px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
        overflow: hidden;
    }

    .answer-option::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        transition: width 0.3s;
    }

    .answer-option:hover {
        border-color: #667eea;
        transform: translateX(8px);
    }

    .answer-option:hover::before {
        width: 100%;
    }

    .answer-option.selected {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
        border-color: #667eea;
        border-width: 3px;
    }

    .answer-option.correct {
        background: #f0fdf4;
        border-color: #22c55e;
    }

    .answer-option.incorrect {
        background: #fef2f2;
        border-color: #ef4444;
    }

    .answer-option.disabled {
        pointer-events: none;
        opacity: 0.7;
    }

    .answer-letter {
        width: 48px;
        height: 48px;
        background: white;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        color: #667eea;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        z-index: 1;
    }

    .answer-option.selected .answer-letter {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .answer-option.correct .answer-letter {
        background: #22c55e;
        color: white;
    }

    .answer-option.incorrect .answer-letter {
        background: #ef4444;
        color: white;
    }

    .answer-text {
        font-size: 16px;
        color: #374151;
        font-weight: 500;
        flex: 1;
        z-index: 1;
    }

    .answer-icon {
        font-size: 24px;
        z-index: 1;
    }

    .hint-box {
        background: #fffbeb;
        border: 2px solid #fbbf24;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 32px;
        display: flex;
        gap: 12px;
    }

    .hint-icon {
        font-size: 24px;
        flex-shrink: 0;
    }

    .hint-content {
        flex: 1;
    }

    .hint-label {
        font-size: 12px;
        font-weight: 700;
        color: #f59e0b;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .hint-text {
        font-size: 14px;
        color: #92400e;
        line-height: 1.5;
    }

    .explanation-box {
        background: #f0fdf4;
        border: 2px solid #86efac;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 32px;
    }

    .explanation-label {
        font-size: 12px;
        font-weight: 700;
        color: #16a34a;
        text-transform: uppercase;
        margin-bottom: 8px;
    }

    .explanation-text {
        font-size: 14px;
        color: #166534;
        line-height: 1.5;
    }

    .question-actions {
        display: flex;
        gap: 12px;
        padding-top: 24px;
        border-top: 2px solid #f3f4f6;
    }

    .btn {
        flex: 1;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .results-screen {
        padding: 60px 40px;
        text-align: center;
    }

    .results-icon {
        font-size: 100px;
        margin-bottom: 24px;
        animation: scaleIn 0.6s ease-out;
    }

    @@keyframes scaleIn {
        from {
            transform: scale(0);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .results-title {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 12px;
    }

    .results-title.excellent {
        color: #16a34a;
    }

    .results-title.good {
        color: #667eea;
    }

    .results-title.needsWork {
        color: #f59e0b;
    }

    .results-subtitle {
        font-size: 18px;
        color: #6b7280;
        margin-bottom: 40px;
    }

    .score-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 40px;
        margin-bottom: 40px;
        position: relative;
        overflow: hidden;
    }

    .score-display::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
    }

    .score-percentage {
        font-size: 72px;
        font-weight: 700;
        margin-bottom: 8px;
        position: relative;
    }

    .score-text {
        font-size: 18px;
        opacity: 0.9;
        position: relative;
    }

    .results-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 40px;
    }

    .stat-box {
        background: #f9fafb;
        border-radius: 16px;
        padding: 24px;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 14px;
        color: #6b7280;
    }

    .review-section {
        text-align: left;
        margin-bottom: 32px;
    }

    .review-title {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 20px;
    }

    .review-item {
        background: #f9fafb;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
    }

    .review-question {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 12px;
    }

    .review-answers {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .review-answer {
        padding: 12px 16px;
        border-radius: 10px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .review-answer.correct {
        background: #f0fdf4;
        color: #166534;
    }

    .review-answer.user-wrong {
        background: #fef2f2;
        color: #991b1b;
    }

    .results-actions {
        display: flex;
        gap: 12px;
    }

    .loading-screen {
        padding: 80px 40px;
        text-align: center;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid #e5e7eb;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 24px;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<div class="quiz-container">
    <div class="background-decoration decoration-1"></div>
    <div class="background-decoration decoration-2"></div>

    <div class="quiz-card">
        @if (isLoading)
        {
            <div class="loading-screen">
                <div class="spinner"></div>
                <p style="color: #6b7280; font-size: 16px;">Loading your quiz...</p>
            </div>
        }
        else if (quiz == null)
        {
            <div class="loading-screen">
                <div style="font-size: 64px; margin-bottom: 16px;">❌</div>
                <p style="color: #6b7280; font-size: 18px;">Quiz not found</p>
            </div>
        }
        else if (!quizStarted)
        {
            <!-- Setup Screen -->
            <div class="quiz-header">
                <div class="quiz-header-content">
                    <h1 class="quiz-title">@quiz.QuizName</h1>
                </div>
            </div>

            <div class="setup-screen">
                <div class="setup-icon">🎯</div>
                <h2 class="setup-title">Ready to Test Your Knowledge?</h2>
                <p class="setup-description">@quiz.Description</p>

                <div class="quiz-info-grid">
                    <div class="info-box">
                        <div class="info-icon">📝</div>
                        <div class="info-value">@totalQuestions</div>
                        <div class="info-label">Total Questions</div>
                    </div>
                    <div class="info-box">
                        <div class="info-icon">⏱️</div>
                        <div class="info-value">~@(selectedQuestionCount * 2)</div>
                        <div class="info-label">Minutes</div>
                    </div>
                </div>

                <div class="question-selector">
                    <div class="selector-label">How many questions would you like to answer?</div>
                    <div class="slider-container">
                        <input type="range" class="slider" min="1" max="@totalQuestions" 
                               @bind="selectedQuestionCount" @bind:event="oninput" />
                        <div class="slider-value">@selectedQuestionCount / @totalQuestions</div>
                    </div>
                </div>

                <button class="start-btn" @onclick="StartQuiz">
                    Start Quiz 🚀
                </button>
            </div>
        }
        else if (!quizFinished)
        {
            <!-- Question Screen -->
            <div class="quiz-header">
                <div class="quiz-header-content">
                    <h1 class="quiz-title">@quiz.QuizName</h1>
                    <div class="quiz-progress">@(currentQuestionIndex + 1) / @selectedQuestions.Count</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: @GetProgressPercentage()%"></div>
                </div>
            </div>

            <div class="question-screen">
                @{
                    var currentQ = selectedQuestions[currentQuestionIndex];
                }

                <div class="question-number">Question @(currentQuestionIndex + 1)</div>
                <div class="question-text">@currentQ.QuestionText</div>

                @if (!string.IsNullOrEmpty(currentQ.Hint) && showHint)
                {
                    <div class="hint-box">
                        <div class="hint-icon">💡</div>
                        <div class="hint-content">
                            <div class="hint-label">Hint</div>
                            <div class="hint-text">@currentQ.Hint</div>
                        </div>
                    </div>
                }

                @if (answerSubmitted && !string.IsNullOrEmpty(correctAnswer?.Explanation))
                {
                    <div class="explanation-box">
                        <div class="explanation-label">Explanation</div>
                        <div class="explanation-text">@correctAnswer.Explanation</div>
                    </div>
                }

                <div class="answers-container">
                    @for (int i = 0; i < currentQ.Answers.Count; i++)
                    {
                        var answer = currentQ.Answers[i];
                        var index = i;
                        var cssClass = "answer-option";
                        
                        if (answerSubmitted)
                        {
                            cssClass += " disabled";
                            if (answer.IsCorrect)
                            {
                                cssClass += " correct";
                            }
                            else if (selectedAnswerIndex == index)
                            {
                                cssClass += " incorrect";
                            }
                        }
                        else if (selectedAnswerIndex == index)
                        {
                            cssClass += " selected";
                        }

                        <div class="@cssClass" @onclick="@(() => SelectAnswer(index))">
                            <div class="answer-letter">@((char)('A' + index))</div>
                            <div class="answer-text">@answer.AnswerText</div>
                            @if (answerSubmitted)
                            {
                                @if (answer.IsCorrect)
                                {
                                    <div class="answer-icon">✓</div>
                                }
                                else if (selectedAnswerIndex == index)
                                {
                                    <div class="answer-icon">✗</div>
                                }
                            }
                        </div>
                    }
                </div>

                <div class="question-actions">
                    @if (!answerSubmitted)
                    {
                        @if (!showHint && !string.IsNullOrEmpty(currentQ.Hint))
                        {
                            <button class="btn btn-secondary" @onclick="ShowHint">
                                💡 Show Hint
                            </button>
                        }
                        <button class="btn btn-primary" @onclick="SubmitAnswer" disabled="@(selectedAnswerIndex == -1)">
                            Submit Answer
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-primary" @onclick="NextQuestion">
                            @(currentQuestionIndex < selectedQuestions.Count - 1 ? "Next Question →" : "See Results 🎉")
                        </button>
                    }
                </div>
            </div>
        }
        else
        {
            <!-- Results Screen -->
            <div class="quiz-header">
                <div class="quiz-header-content">
                    <h1 class="quiz-title">Quiz Complete!</h1>
                </div>
            </div>

            <div class="results-screen">
                <div class="results-icon">@GetResultsEmoji()</div>
                <h2 class="results-title @GetResultsClass()">@GetResultsTitle()</h2>
                <p class="results-subtitle">@GetResultsMessage()</p>

                <div class="score-display">
                    <div class="score-percentage">@scorePercentage%</div>
                    <div class="score-text">Your Score</div>
                </div>

                <div class="results-stats">
                    <div class="stat-box">
                        <div class="stat-value" style="color: #22c55e;">@correctAnswers</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="color: #ef4444;">@(selectedQuestions.Count - correctAnswers)</div>
                        <div class="stat-label">Incorrect</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="color: #667eea;">@selectedQuestions.Count</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>

                <div class="review-section">
                    <h3 class="review-title">Review Your Answers</h3>
                    @for (int i = 0; i < selectedQuestions.Count; i++)
                    {
                        var q = selectedQuestions[i];
                        var userAnswer = userAnswers[i];
                        var isCorrect = q.Answers[userAnswer].IsCorrect;

                        <div class="review-item">
                            <div class="review-question">Q@(i + 1): @q.QuestionText</div>
                            <div class="review-answers">
                                @foreach (var answer in q.Answers)
                                {
                                    @if (answer.IsCorrect)
                                    {
                                        <div class="review-answer correct">
                                            ✓ @answer.AnswerText @(answer.IsCorrect ? "(Correct Answer)" : "")
                                        </div>
                                    }
                                    else if (q.Answers.IndexOf(answer) == userAnswer && !isCorrect)
                                    {
                                        <div class="review-answer user-wrong">
                                            ✗ @answer.AnswerText (Your Answer)
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="review-section">
                    <h3 class="review-title">Rate the Questions ⭐</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Help improve the quiz by rating each question</p>
                    @for (int i = 0; i < selectedQuestions.Count; i++)
                    {
                        var q = selectedQuestions[i];
                        var qIndex = i;
                        var timeTaken = questionTimes[i];

                        <div class="review-item">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div class="review-question" style="flex: 1;">Q@(i + 1): @q.QuestionText</div>
                                <div style="color: #667eea; font-size: 13px; font-weight: 600;">
                                    ⏱️ @timeTaken sec
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="font-size: 14px; color: #6b7280; margin-right: 8px;">Your rating:</span>
                                @for (int star = 1; star <= 5; star++)
                                {
                                    var starValue = star;
                                    <button @onclick="@(() => RateQuestion(qIndex, starValue))"
                                            style="background: none; border: none; cursor: pointer; font-size: 28px; padding: 4px; transition: transform 0.2s;"
                                            onmouseover="this.style.transform='scale(1.2)'"
                                            onmouseout="this.style.transform='scale(1)'">
                                        @(GetQuestionRating(qIndex) >= starValue ? "⭐" : "☆")
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="results-actions">
                    <button class="btn btn-secondary" @onclick="GoToSearch">
                        Browse Quizzes
                    </button>
                    <button class="btn btn-primary" @onclick="RetakeQuiz">
                        🔄 Retake Quiz
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public int QuizId { get; set; }

    private Quiz quiz;
    private List<Question> selectedQuestions = new();
    private Dictionary<int, int> userAnswers = new();
    
    private bool isLoading = true;
    private bool quizStarted = false;
    private bool quizFinished = false;
    private bool answerSubmitted = false;
    private bool showHint = false;
    
    private int totalQuestions = 0;
    private int selectedQuestionCount = 5;
    private int currentQuestionIndex = 0;
    private int selectedAnswerIndex = -1;
    private int correctAnswers = 0;
    private int scorePercentage = 0;
    private Answer correctAnswer;

    // ✅ מעקב אחר זמן ומשתמש
    private int currentStudentId = 0;
    private List<bool> hintsUsed = new();
    private List<int> questionTimes = new();
    private DateTime questionStartTime;
    private Dictionary<int, int> questionRatings = new();

    protected override async Task OnInitializedAsync()
    {
        // ✅ שליפת המשתמש המחובר
        try
        {
            var result = await session.GetAsync<Customers>("user");
            if (result.Success && result.Value != null)
            {
                currentStudentId = result.Value.user_id;
            }
            else
            {
                nav.NavigateTo("/login");
                return;
            }
        }
        catch
        {
            nav.NavigateTo("/login");
            return;
        }

        await LoadQuizAsync();
    }

    private async Task LoadQuizAsync()
    {
        try
        {
            isLoading = true;
            var db = new QuizDB();
            quiz = await db.GetQuizWithQuestionsAsync(QuizId);
            
            if (quiz != null && quiz.Questions != null)
            {
                totalQuestions = quiz.Questions.Count;
                selectedQuestionCount = Math.Min(5, totalQuestions);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading quiz: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void StartQuiz()
    {
        // בחירה אקראית של שאלות
        var random = new Random();
        selectedQuestions = quiz.Questions
            .OrderBy(x => random.Next())
            .Take(selectedQuestionCount)
            .ToList();
        
        quizStarted = true;
        currentQuestionIndex = 0;
        correctAnswers = 0;
        userAnswers.Clear();
        
        // ✅ אתחול מעקב
        hintsUsed = new List<bool>(new bool[selectedQuestions.Count]);
        questionTimes = new List<int>(new int[selectedQuestions.Count]);
        questionStartTime = DateTime.Now; // ✅ התחלת טיימר לשאלה הראשונה
    }

    private void SelectAnswer(int index)
    {
        if (!answerSubmitted)
        {
            selectedAnswerIndex = index;
        }
    }

    private void ShowHint()
    {
        showHint = true;
        hintsUsed[currentQuestionIndex] = true; // ✅ סימון שהשתמש ברמז
    }

    private async Task SubmitAnswer()
    {
        if (selectedAnswerIndex == -1) return;

        // ✅ חישוב זמן שלקח לענות על השאלה
        var timeTaken = (int)(DateTime.Now - questionStartTime).TotalSeconds;
        questionTimes[currentQuestionIndex] = timeTaken;

        answerSubmitted = true;
        userAnswers[currentQuestionIndex] = selectedAnswerIndex;

        var currentQ = selectedQuestions[currentQuestionIndex];
        correctAnswer = currentQ.Answers.FirstOrDefault(a => a.IsCorrect);
        
        bool isCorrect = currentQ.Answers[selectedAnswerIndex].IsCorrect;
        if (isCorrect)
        {
            correctAnswers++;
        }

        // ✅ שמירת התוצאה במסד נתונים
        await SaveResultAsync(currentQ, isCorrect, timeTaken);
    }

    private async Task SaveResultAsync(Question question, bool isCorrect, int timeTaken)
    {
        try
        {
            var resultDb = new ResultDB();
            var result = new Result
            {
                student_id = currentStudentId,
                question_id = question.QuestionID,
                quiz_id = QuizId,
                is_correct = isCorrect ? 1 : 0,
                used_hint = hintsUsed[currentQuestionIndex] ? 1 : 0,
                time_taken = timeTaken, // ✅ זמן בשניות
                rating = 0,
                score = 0, // יתעדכן בסוף
                answered_at = DateTime.Now
            };

            await resultDb.InsertResultAsync(result);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving result: {ex.Message}");
        }
    }

    private void NextQuestion()
    {
        if (currentQuestionIndex < selectedQuestions.Count - 1)
        {
            currentQuestionIndex++;
            selectedAnswerIndex = -1;
            answerSubmitted = false;
            showHint = false;
            correctAnswer = null;
            questionStartTime = DateTime.Now; // ✅ התחלת טיימר לשאלה הבאה
        }
        else
        {
            FinishQuiz();
        }
    }

    private async void FinishQuiz()
    {
        quizFinished = true;
        scorePercentage = (int)Math.Round((double)correctAnswers / selectedQuestions.Count * 100);
        
        // ✅ שמירת הציון הסופי במסד נתונים
        await SaveFinalScoreAsync();
    }

    private async Task SaveFinalScoreAsync()
    {
        try
        {
            var resultDb = new ResultDB();
            await resultDb.UpdateQuizScoreAsync(currentStudentId, QuizId, scorePercentage);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving final score: {ex.Message}");
        }
    }

    private void RetakeQuiz()
    {
        quizStarted = false;
        quizFinished = false;
        answerSubmitted = false;
        showHint = false;
        currentQuestionIndex = 0;
        selectedAnswerIndex = -1;
        correctAnswers = 0;
        userAnswers.Clear();
        selectedQuestions.Clear();
        hintsUsed.Clear();
        questionTimes.Clear();
        questionRatings.Clear();
    }

    // ✅ פונקציות דירוג
    private void RateQuestion(int questionIndex, int rating)
    {
        questionRatings[questionIndex] = rating;
        SaveQuestionRating(selectedQuestions[questionIndex].QuestionID, rating);
    }

    private int GetQuestionRating(int questionIndex)
    {
        return questionRatings.ContainsKey(questionIndex) ? questionRatings[questionIndex] : 0;
    }

    private async void SaveQuestionRating(int questionId, int rating)
    {
        try
        {
            var resultDb = new ResultDB();
            var results = await resultDb.GetStudentQuizResultsAsync(currentStudentId, QuizId);
            var result = results.FirstOrDefault(r => r.question_id == questionId);
            
            if (result != null)
            {
                await resultDb.UpdateRatingAsync(result.result_id, rating);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving rating: {ex.Message}");
        }
    }

    private void GoToSearch()
    {
        nav.NavigateTo("/search-quizzes");
    }

    private double GetProgressPercentage()
    {
        return ((double)(currentQuestionIndex + 1) / selectedQuestions.Count) * 100;
    }

    private string GetResultsEmoji()
    {
        if (scorePercentage >= 80) return "🏆";
        if (scorePercentage >= 60) return "🎉";
        return "📚";
    }

    private string GetResultsClass()
    {
        if (scorePercentage >= 80) return "excellent";
        if (scorePercentage >= 60) return "good";
        return "needsWork";
    }

    private string GetResultsTitle()
    {
        if (scorePercentage >= 80) return "Excellent Work!";
        if (scorePercentage >= 60) return "Good Job!";
        return "Keep Practicing!";
    }

    private string GetResultsMessage()
    {
        if (scorePercentage >= 80) return "You've mastered this topic! Outstanding performance!";
        if (scorePercentage >= 60) return "You're on the right track. A bit more practice and you'll ace it!";
        return "Don't worry, practice makes perfect. Review the material and try again!";
    }
    }