@page "/teacher-home"
@using DBL
@using Models
@inject NavigationManager nav
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage session

<PageTitle>EduQuest | Teacher Dashboard</PageTitle>

<style>
    body {
        margin: 0;
        background: #f5f7fa;
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    .dashboard {
        display: flex;
        height: 100vh;
        background: #f5f7fa;
    }

    /* ── Sidebar ── */
    .sidebar {
        width: 240px;
        background: white;
        display: flex;
        flex-direction: column;
        padding: 24px 20px;
        box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 40px;
        padding: 0 8px;
    }

    .logo-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        font-weight: 700;
    }

    .logo-text {
        font-size: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .sidebar-menu {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
    }

    .sidebar-item {
        display: flex;
        align-items: center;
        gap: 12px;
        background: none;
        border: none;
        cursor: pointer;
        color: #6b7280;
        font-size: 15px;
        padding: 12px 16px;
        border-radius: 10px;
        transition: all 0.2s;
        text-align: left;
        font-weight: 500;
        width: 100%;
        position: relative;
    }

        .sidebar-item:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .sidebar-item.active {
            background: #eff6ff;
            color: #3b82f6;
            font-weight: 600;
        }

        .sidebar-item span:first-child {
            font-size: 20px;
        }

    /* Badge on sidebar item (e.g. pending requests count) */
    .sidebar-badge {
        margin-left: auto;
        background: #ef4444;
        color: white;
        font-size: 11px;
        font-weight: 700;
        min-width: 20px;
        height: 20px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 6px;
    }

    /* ── Main layout ── */
    .main-container {
        flex: 1;
        display: flex;
        gap: 24px;
        padding: 32px;
        overflow: hidden;
    }

    .main-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 12px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
    }

    .greeting {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }

    .greeting-sub {
        color: #6b7280;
        font-size: 15px;
        margin-top: 4px;
    }

    .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .user-avatar {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
        font-size: 16px;
    }

        .user-avatar:hover {
            transform: scale(1.05);
        }

    /* ── Stats grid ── */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        transition: transform 0.2s;
    }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 16px;
    }

        .stat-icon.blue {
            background: #eff6ff;
        }

        .stat-icon.purple {
            background: #f5f3ff;
        }

        .stat-icon.green {
            background: #f0fdf4;
        }

        .stat-icon.red {
            background: #fef2f2;
        }

        .stat-icon.orange {
            background: #fff7ed;
        }

    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
    }

    /* ── Create quiz banner ── */
    .create-card {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 20px;
        padding: 32px;
        color: white;
        margin-bottom: 32px;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .create-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

    .create-content h2 {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 8px 0;
    }

    .create-content p {
        opacity: 0.9;
        margin: 0;
        font-size: 15px;
    }

    .create-btn {
        background: white;
        color: #3b82f6;
        border: none;
        padding: 14px 28px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        z-index: 1;
        font-family: 'Poppins', sans-serif;
    }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

    /* ── Sections ── */
    .section {
        background: white;
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
    }

    .view-all {
        color: #3b82f6;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: color 0.2s;
    }

        .view-all:hover {
            color: #8b5cf6;
        }

    /* ── Quiz cards ── */
    .quiz-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .quiz-card {
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 14px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s;
    }

        .quiz-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

    .quiz-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
    }

    .quiz-topic {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
    }

    .quiz-badge {
        background: #eff6ff;
        color: #3b82f6;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .quiz-text {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 12px;
        line-height: 1.5;
    }

    .quiz-meta {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: #9ca3af;
    }

        .quiz-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

    /* ── Right sidebar ── */
    .sidebar-right {
        width: 320px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        overflow-y: auto;
    }

    .widget {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .widget-title {
        font-size: 16px;
        font-weight: 700;
        color: #1f2937;
    }

    .widget-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 700;
    }

        .widget-badge.red {
            background: #fef2f2;
            color: #ef4444;
        }

        .widget-badge.blue {
            background: #eff6ff;
            color: #3b82f6;
        }

        .widget-badge.orange {
            background: #fff7ed;
            color: #f97316;
        }

    /* ── Struggling students ── */
    .student-item {
        display: flex;
        gap: 12px;
        padding: 12px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 10px;
        margin-bottom: 12px;
        transition: all 0.2s;
        cursor: pointer;
    }

        .student-item:hover {
            background: #fee2e2;
            border-color: #fca5a5;
        }

    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
    }

    .student-info {
        flex: 1;
    }

    .student-name {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 2px;
    }

    .student-issue {
        font-size: 12px;
        color: #dc2626;
        font-weight: 500;
    }

    /* ── Tutoring request items ── */
    .request-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 12px;
        transition: all 0.2s;
        border-left: 3px solid #f97316;
    }

        .request-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

    .request-top {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        margin-bottom: 10px;
    }

    .request-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 13px;
        flex-shrink: 0;
    }

    .request-info {
        flex: 1;
    }

    .request-student {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 2px;
    }

    .request-subject {
        font-size: 12px;
        color: #6b7280;
    }

    .request-datetime {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 2px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .request-actions {
        display: flex;
        gap: 8px;
    }

    .request-btn {
        flex: 1;
        padding: 7px 0;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        font-family: 'Poppins', sans-serif;
    }

        .request-btn.accept {
            background: #dcfce7;
            color: #16a34a;
        }

            .request-btn.accept:hover {
                background: #bbf7d0;
            }

        .request-btn.decline {
            background: #fee2e2;
            color: #dc2626;
        }

            .request-btn.decline:hover {
                background: #fecaca;
            }

        .request-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    /* ── Top quizzes widget ── */
    .quiz-stats-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #f9fafb;
        border-radius: 10px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

        .quiz-stats-item:hover {
            background: #f3f4f6;
        }

    .quiz-stat-info {
        flex: 1;
    }

    .quiz-stat-name {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
    }

    .quiz-stat-meta {
        font-size: 12px;
        color: #6b7280;
    }

    .quiz-stat-score {
        text-align: right;
    }

    .score-value {
        font-size: 20px;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 2px;
    }

    .score-label {
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
    }

    /* ── Empty / utility ── */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #9ca3af;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .logout-btn {
        background: #fef2f2;
        border: none;
        color: #dc2626;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        font-family: 'Poppins', sans-serif;
    }

        .logout-btn:hover {
            background: #fee2e2;
        }

    .view-all-link {
        display: block;
        text-align: center;
        color: #3b82f6;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: background 0.2s;
        margin-top: 4px;
    }

        .view-all-link:hover {
            background: #eff6ff;
        }
</style>

<div class="dashboard">

    <!-- ══ Left Sidebar ══ -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">Q</div>
            <div class="logo-text">EduQuest</div>
        </div>
        <div class="sidebar-menu">
            <button class="sidebar-item active" @onclick="@(()=>nav.NavigateTo("/teacher-home"))">
                <span>🏠</span>
                <span>Dashboard</span>
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/create-quiz"))">
                <span>➕</span>
                <span>Quick Create</span>
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/my-quizzes"))">
                <span>📚</span>
                <span>My Quizzes</span>
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/requests"))">
                <span>📬</span>
                <span>Requests</span>
                @if (pendingRequestsCount > 0)
                {
                    <span class="sidebar-badge">@pendingRequestsCount</span>
                }
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/students"))">
                <span>👥</span>
                <span>Students</span>
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/profile-teacher"))">
                <span>⚙️</span>
                <span>Settings</span>
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/notifications-teacher"))">
                <span>🔔</span>
                <span>Notifications</span>
                @if (pendingRequestsCount > 0)
                {
                    <span class="sidebar-badge">@pendingRequestsCount</span>
                }
            </button>
        </div>
    </aside>

    <!-- ══ Main ══ -->
    <div class="main-container">
        <main class="main-content">

            <!-- Header -->
            <div class="header">
                <div>
                    <h1 class="greeting">Welcome back, @teacherName!</h1>
                    <p class="greeting-sub">Here's what's happening with your students today</p>
                </div>
                <div class="header-actions">
                    <button class="logout-btn" @onclick="Logout">Logout</button>
                    <div class="user-avatar">@GetInitials(teacherName)</div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon green">✓</div>
                    <div class="stat-value">@completedToday</div>
                    <div class="stat-label">Completed Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">👥</div>
                    <div class="stat-value">@totalStudents</div>
                    <div class="stat-label">Active Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon blue">✓</div>
                    <div class="stat-value">@totalCompletions</div>
                    <div class="stat-label">Total Completions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">📬</div>
                    <div class="stat-value">@pendingRequestsCount</div>
                    <div class="stat-label">Pending Requests</div>
                </div>
            </div>

            <!-- Create quiz banner -->
            <div class="create-card">
                <div class="create-content">
                    <h2>Create a new quiz</h2>
                    <p>Build engaging quizzes for your students in minutes</p>
                </div>
                <button class="create-btn" @onclick="@(()=>nav.NavigateTo("/create-quiz"))">
                    <span>➕</span>
                    <span>Create Quiz</span>
                </button>
            </div>

            <!-- Recent Quizzes -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Recent Quizzes</h2>
                    <span class="view-all" @onclick="@(()=>nav.NavigateTo("/my-quizzes"))">View all →</span>
                </div>

                @if (recentQuizzes == null)
                {
                    <div class="empty-state">
                        <div class="empty-icon">⏳</div>
                        <p>Loading your quizzes...</p>
                    </div>
                }
                else if (recentQuizzes.Count == 0)
                {
                    <div class="empty-state">
                        <div class="empty-icon">📚</div>
                        <p>No quizzes yet. Create your first one!</p>
                    </div>
                }
                else
                {
                    <div class="quiz-grid">
                        @foreach (var quiz in recentQuizzes.Take(4))
                        {
                            <div class="quiz-card" @onclick="@(()=>nav.NavigateTo($"/quiz-details/{quiz.QuizId}"))">
                                <div class="quiz-header">
                                    <div class="quiz-topic">@quiz.QuizName</div>
                                    <div class="quiz-badge">Active</div>
                                </div>
                                <div class="quiz-text">@quiz.Description</div>
                                <div class="quiz-meta">
                                    <span>📝 @(quiz.Questions?.Count ?? 0) questions</span>
                                    <span>📅 @quiz.CreatedAt.ToString("dd MMM")</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

        </main>

        <!-- ══ Right Sidebar ══ -->
        <aside class="sidebar-right">

            <!-- Struggling Students -->
            <div class="widget">
                <div class="widget-header">
                    <h3 class="widget-title">Struggling Students</h3>
                    <div class="widget-badge red">@strugglingStudents.Count</div>
                </div>
                @if (strugglingStudents.Count == 0)
                {
                    <div style="text-align:center; padding:20px; color:#6b7280;">
                        <p>🎉 All students are doing well!</p>
                    </div>
                }
                else
                {
                    @foreach (var student in strugglingStudents)
                    {
                        <div class="student-item"
                             @onclick="@(()=>nav.NavigateTo($"/student-details/{student.StudentId}"))">
                            <div class="student-avatar">@GetInitials(student.StudentName)</div>
                            <div class="student-info">
                                <div class="student-name">@student.StudentName</div>
                                <div class="student-issue">@student.Issue</div>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- ★ LIVE Tutoring Requests from DB ★ -->
            <div class="widget">
                <div class="widget-header">
                    <h3 class="widget-title">📬 Tutoring Requests</h3>
                    <div class="widget-badge orange">@pendingRequests.Count pending</div>
                </div>

                @if (pendingRequests.Count == 0)
                {
                    <div style="text-align:center; padding:20px; color:#6b7280;">
                        <p style="font-size:28px; margin-bottom:8px;">📭</p>
                        <p>No pending requests</p>
                    </div>
                }
                else
                {
                    @foreach (var req in pendingRequests.Take(3))
                    {
                        <div class="request-item">
                            <div class="request-top">
                                <div class="request-avatar">@GetInitials(req.StudentName)</div>
                                <div class="request-info">
                                    <div class="request-student">@req.StudentName</div>
                                    <div class="request-subject">📖 @req.Subject</div>
                                    <div class="request-datetime">
                                        📅 @req.RequestedDateTime.ToString("dd MMM, HH:mm")
                                        · @req.DurationMinutes min
                                    </div>
                                </div>
                            </div>
                            <div class="request-actions">
                                <button class="request-btn accept"
                                        @onclick="@(async () => await RespondToRequest(req.RequestId, "Accepted"))"
                                        disabled="@req.IsProcessing">
                                    ✓ Accept
                                </button>
                                <button class="request-btn decline"
                                        @onclick="@(async () => await RespondToRequest(req.RequestId, "Declined"))"
                                        disabled="@req.IsProcessing">
                                    ✕ Decline
                                </button>
                            </div>
                        </div>
                    }

                    @if (pendingRequests.Count > 3)
                    {
                        <span class="view-all-link"
                              @onclick="@(()=>nav.NavigateTo("/requests"))">
                            View all @pendingRequests.Count requests →
                        </span>
                    }
                }

                <span class="view-all-link"
                      @onclick="@(()=>nav.NavigateTo("/requests"))">
                    Manage all requests →
                </span>
            </div>

            <!-- Top Performing Quizzes -->
            <div class="widget">
                <h3 class="widget-title">Top Performing Quizzes</h3>
                @if (topPerformingQuizzes.Count == 0)
                {
                    <div style="text-align:center; padding:20px; color:#6b7280;">
                        <p style="font-size:32px; margin-bottom:8px;">📊</p>
                        <p>No quiz data yet</p>
                    </div>
                }
                else
                {
                    @foreach (var quiz in topPerformingQuizzes)
                    {
                        <div class="quiz-stats-item"
                             @onclick="@(()=>nav.NavigateTo($"/quiz-details/{quiz.QuizId}"))">
                            <div class="quiz-stat-info">
                                <div class="quiz-stat-name">@quiz.QuizName</div>
                                <div class="quiz-stat-meta">@quiz.Completions completions</div>
                            </div>
                            <div class="quiz-stat-score">
                                <div class="score-value">@quiz.AverageScore%</div>
                                <div class="score-label">Avg Score</div>
                            </div>
                        </div>
                    }
                }
            </div>

        </aside>
    </div>
</div>

@code {
    /* ── Auth ── */
    private string teacherName = "";
    private int teacherId = 0;
    private bool _initialized = false;

    /* ── Quiz data ── */
    private List<Quiz> recentQuizzes;

    /* ── Stats ── */
    private int totalStudents = 0;
    private int totalCompletions = 0;
    private int completedToday = 0;

    /* ── Requests ── */
    private List<PendingRequestVM> pendingRequests = new();
    private int pendingRequestsCount = 0;

    /* ── Struggling students ── */
    private List<StrugglingStudent> strugglingStudents = new();
    private List<TopQuiz> topPerformingQuizzes = new();

    /* ══════════════════════════════════════
       LIFECYCLE
    ═══════════════════════════════════════ */
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _initialized) return;
        _initialized = true;

        try
        {
            var result = await session.GetAsync<Customers>("user");
            if (result.Success && result.Value != null)
            {
                teacherName = result.Value.FullName;
                teacherId = result.Value.user_id;

                await LoadAllDataAsync(teacherId);
            }
            else
            {
                nav.NavigateTo("/login");
                return;
            }
        }
        catch
        {
            nav.NavigateTo("/login");
            return;
        }

        StateHasChanged();
    }

    /* ══════════════════════════════════════
       DATA LOADING
    ═══════════════════════════════════════ */
    private async Task LoadAllDataAsync(int tid)
    {
        await LoadRecentQuizzesAsync(tid);
        await LoadTeacherStatisticsAsync(tid);
        await LoadStrugglingStudentsAsync(tid);
        await LoadTopPerformingQuizzesAsync(tid);
        await LoadPendingRequestsAsync(tid);       // ← NEW
    }

    private async Task LoadRecentQuizzesAsync(int tid)
    {
        try
        {
            var db = new QuizDB();
            recentQuizzes = await db.GetQuizzesByTeacherAsync(tid);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadRecentQuizzes: {ex.Message}");
        }
    }

    /* ── Live pending requests from DB ── */
    private async Task LoadPendingRequestsAsync(int tid)
    {
        try
        {
            var requestDb = new RequestDB();
            var customerDb = new CustomerDB();
            var allRequests = await requestDb.GetPendingRequestsAsync(tid);

            var vms = new List<PendingRequestVM>();
            foreach (var req in allRequests)
            {
                var student = await customerDb.SelectByPkAsync(req.StudentId);
                vms.Add(new PendingRequestVM
                    {
                        RequestId = req.RequestId,
                        StudentName = student?.FullName ?? "Unknown Student",
                        Subject = req.Subject,
                        RequestedDateTime = req.RequestedDateTime,
                        DurationMinutes = req.DurationMinutes,
                        Notes = req.Notes,
                        IsProcessing = false
                    });
            }

            pendingRequests = vms;
            pendingRequestsCount = vms.Count;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadPendingRequests: {ex.Message}");
            pendingRequests = new();
            pendingRequestsCount = 0;
        }
    }

    /* ── Accept / Decline directly from widget ── */
    private async Task RespondToRequest(int requestId, string status)
    {
        var req = pendingRequests.FirstOrDefault(r => r.RequestId == requestId);
        if (req == null) return;

        req.IsProcessing = true;
        StateHasChanged();

        try
        {
            var requestDb = new RequestDB();
            await requestDb.UpdateRequestStatusAsync(requestId, status);

            // Remove from the live list
            pendingRequests.Remove(req);
            pendingRequestsCount = pendingRequests.Count;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"RespondToRequest: {ex.Message}");
            req.IsProcessing = false;
        }

        StateHasChanged();
    }

    private async Task LoadTeacherStatisticsAsync(int tid)
    {
        try
        {
            var quizDb = new QuizDB();
            var teacherQuizzes = await quizDb.GetQuizzesByTeacherAsync(tid);
            if (teacherQuizzes.Count == 0) return;

            var resultDb = new ResultDB();
            var uniqueStudents = new HashSet<int>();
            int completions = 0;
            var today = DateTime.Today;

            foreach (var quiz in teacherQuizzes)
            {
                var results = await resultDb.GetAllQuizResultsAsync(quiz.QuizId);

                completedToday += results
                    .Where(r => r.score > 0 && r.answered_at.Date == today)
                    .Select(r => r.student_id)
                    .Distinct()
                    .Count();

                foreach (var sid in results.Select(r => r.student_id).Distinct())
                    uniqueStudents.Add(sid);

                completions += results
                    .Where(r => r.score > 0)
                    .Select(r => r.student_id)
                    .Distinct()
                    .Count();
            }

            totalStudents = uniqueStudents.Count;
            totalCompletions = completions;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadTeacherStatistics: {ex.Message}");
        }
    }

    private async Task LoadStrugglingStudentsAsync(int tid)
    {
        try
        {
            var quizDb = new QuizDB();
            var teacherQuizzes = await quizDb.GetQuizzesByTeacherAsync(tid);
            var resultDb = new ResultDB();
            var customerDb = new CustomerDB();
            var studentIssues = new Dictionary<int, (string name, string issue, int score)>();

            foreach (var quiz in teacherQuizzes)
            {
                var results = await resultDb.GetAllQuizResultsAsync(quiz.QuizId);
                foreach (var group in results.GroupBy(r => r.student_id))
                {
                    var sid = group.Key;
                    var score = group.FirstOrDefault()?.score ?? 0;
                    if (score < 60 && score > 0 && !studentIssues.ContainsKey(sid))
                    {
                        var student = await customerDb.SelectByPkAsync(sid);
                        if (student != null)
                        {
                            string issue = score < 50
                                ? $"Failed {quiz.QuizName} – {score}%"
                                : $"Low score in {quiz.QuizName} – {score}%";
                            studentIssues[sid] = (student.FullName, issue, score);
                        }
                    }
                }
            }

            strugglingStudents = studentIssues
                .Select(kvp => new StrugglingStudent
                    {
                        StudentId = kvp.Key,
                        StudentName = kvp.Value.name,
                        Issue = kvp.Value.issue,
                        Score = kvp.Value.score
                    })
                .OrderBy(s => s.Score)
                .Take(3)
                .ToList();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadStrugglingStudents: {ex.Message}");
        }
    }

    private async Task LoadTopPerformingQuizzesAsync(int tid)
    {
        try
        {
            var quizDb = new QuizDB();
            var teacherQuizzes = await quizDb.GetQuizzesByTeacherAsync(tid);
            var resultDb = new ResultDB();
            var list = new List<TopQuiz>();

            foreach (var quiz in teacherQuizzes)
            {
                var results = await resultDb.GetAllQuizResultsAsync(quiz.QuizId);
                if (results.Count == 0) continue;

                var completions = results
                    .Where(r => r.score > 0)
                    .Select(r => r.student_id)
                    .Distinct()
                    .Count();

                var scores = results
                    .Where(r => r.score > 0)
                    .GroupBy(r => r.student_id)
                    .Select(g => g.First().score)
                    .ToList();

                if (completions > 0)
                    list.Add(new TopQuiz
                        {
                            QuizId = quiz.QuizId,
                            QuizName = quiz.QuizName,
                            Completions = completions,
                            AverageScore = scores.Count > 0 ? (int)scores.Average() : 0
                        });
            }

            topPerformingQuizzes = list
                .OrderByDescending(q => q.AverageScore)
                .ThenByDescending(q => q.Completions)
                .Take(3)
                .ToList();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadTopPerformingQuizzes: {ex.Message}");
        }
    }

    /* ══════════════════════════════════════
       HELPERS
    ═══════════════════════════════════════ */
    private async Task Logout()
    {
        await session.DeleteAsync("user");
        nav.NavigateTo("/login", true);
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "T";
        var parts = name.Split(' ');
        if (parts.Length >= 2) return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name[0].ToString().ToUpper();
    }

    /* ══════════════════════════════════════
       INNER CLASSES
    ═══════════════════════════════════════ */
    private class PendingRequestVM
    {
        public int RequestId { get; set; }
        public string StudentName { get; set; }
        public string Subject { get; set; }
        public DateTime RequestedDateTime { get; set; }
        public int DurationMinutes { get; set; }
        public string Notes { get; set; }
        public bool IsProcessing { get; set; }
    }

    private class StrugglingStudent
    {
        public int StudentId { get; set; }
        public string StudentName { get; set; }
        public string Issue { get; set; }
        public int Score { get; set; }
    }

    private class TopQuiz
    {
        public int QuizId { get; set; }
        public string QuizName { get; set; }
        public int Completions { get; set; }
        public int AverageScore { get; set; }
    }
}
