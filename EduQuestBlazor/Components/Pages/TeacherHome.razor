@page "/teacher-home"
@using DBL
@using Models
@inject NavigationManager nav
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage session

<PageTitle>EduQuest | Teacher Dashboard</PageTitle>

<style>
    body {
        margin: 0;
        background: #f5f7fa;
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    .dashboard {
        display: flex;
        height: 100vh;
        background: #f5f7fa;
    }

    .sidebar {
        width: 240px;
        background: white;
        display: flex;
        flex-direction: column;
        padding: 24px 20px;
        box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 40px;
        padding: 0 8px;
    }

    .logo-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        font-weight: 700;
    }

    .logo-text {
        font-size: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .sidebar-menu {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
    }

    .sidebar-item {
        display: flex;
        align-items: center;
        gap: 12px;
        background: none;
        border: none;
        cursor: pointer;
        color: #6b7280;
        font-size: 15px;
        padding: 12px 16px;
        border-radius: 10px;
        transition: all 0.2s;
        text-align: left;
        font-weight: 500;
    }

        .sidebar-item:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .sidebar-item.active {
            background: #eff6ff;
            color: #3b82f6;
            font-weight: 600;
        }

        .sidebar-item span:first-child {
            font-size: 20px;
        }

    .alert-badge {
        position: relative;
    }

        .alert-badge::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
        }

    .main-container {
        flex: 1;
        display: flex;
        gap: 24px;
        padding: 32px;
        overflow: hidden;
    }

    .main-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 12px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
    }

    .greeting {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }

    .greeting-sub {
        color: #6b7280;
        font-size: 15px;
        margin-top: 4px;
    }

    .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .user-avatar {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
        font-size: 16px;
    }

        .user-avatar:hover {
            transform: scale(1.05);
        }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        transition: transform 0.2s;
    }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 16px;
    }

        .stat-icon.blue {
            background: #eff6ff;
        }

        .stat-icon.purple {
            background: #f5f3ff;
        }

        .stat-icon.green {
            background: #f0fdf4;
        }

        .stat-icon.red {
            background: #fef2f2;
        }

    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
    }

    .create-card {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 20px;
        padding: 32px;
        color: white;
        margin-bottom: 32px;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .create-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

    .create-content h2 {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 8px 0;
    }

    .create-content p {
        opacity: 0.9;
        margin: 0;
        font-size: 15px;
    }

    .create-btn {
        background: white;
        color: #3b82f6;
        border: none;
        padding: 14px 28px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        z-index: 1;
    }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

    .section {
        background: white;
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
    }

    .view-all {
        color: #3b82f6;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: color 0.2s;
    }

        .view-all:hover {
            color: #8b5cf6;
        }

    .quiz-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .quiz-card {
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 14px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s;
    }

        .quiz-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

    .quiz-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
    }

    .quiz-topic {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
    }

    .quiz-badge {
        background: #eff6ff;
        color: #3b82f6;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .quiz-text {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 12px;
        line-height: 1.5;
    }

    .quiz-meta {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: #9ca3af;
    }

        .quiz-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

    .sidebar-right {
        width: 320px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        overflow-y: auto;
    }

    .widget {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .widget-title {
        font-size: 16px;
        font-weight: 700;
        color: #1f2937;
    }

    .widget-badge {
        background: #fef2f2;
        color: #ef4444;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 700;
    }

    .student-item {
        display: flex;
        gap: 12px;
        padding: 12px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 10px;
        margin-bottom: 12px;
        transition: all 0.2s;
        cursor: pointer;
    }

        .student-item:hover {
            background: #fee2e2;
            border-color: #fca5a5;
        }

    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
    }

    .student-info {
        flex: 1;
    }

    .student-name {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 2px;
    }

    .student-issue {
        font-size: 12px;
        color: #dc2626;
        font-weight: 500;
    }

    .request-item {
        display: flex;
        gap: 12px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 10px;
        margin-bottom: 12px;
    }

    .request-date {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    .date-day {
        font-size: 18px;
        font-weight: 700;
        line-height: 1;
    }

    .date-month {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        opacity: 0.9;
    }

    .request-info {
        flex: 1;
    }

    .request-student {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 2px;
    }

    .request-subject {
        font-size: 12px;
        color: #6b7280;
    }

    .request-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    .request-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

        .request-btn.accept {
            background: #dcfce7;
            color: #16a34a;
        }

            .request-btn.accept:hover {
                background: #bbf7d0;
            }

        .request-btn.decline {
            background: #fee2e2;
            color: #dc2626;
        }

            .request-btn.decline:hover {
                background: #fecaca;
            }

    .quiz-stats-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #f9fafb;
        border-radius: 10px;
        margin-bottom: 12px;
    }

    .quiz-stat-info {
        flex: 1;
    }

    .quiz-stat-name {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
    }

    .quiz-stat-meta {
        font-size: 12px;
        color: #6b7280;
    }

    .quiz-stat-score {
        text-align: right;
    }

    .score-value {
        font-size: 20px;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 2px;
    }

    .score-label {
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #9ca3af;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .logout-btn {
        background: #fef2f2;
        border: none;
        color: #dc2626;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }

        .logout-btn:hover {
            background: #fee2e2;
        }
</style>

<div class="dashboard">
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">Q</div>
            <div class="logo-text">EduQuest</div>
        </div>
        <div class="sidebar-menu">
            <button class="sidebar-item active" @onclick="@(()=>nav.NavigateTo("/teacher-home"))">
                <span>🏠</span>
                <span>Dashboard</span>
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/create-quiz"))">
                <span>➕</span>
                <span>Quick Create</span>
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/my-quizzes"))">
                <span>📚</span>
                <span>My Quizzes</span>
            </button>
            <button class="sidebar-item alert-badge" @onclick="@(()=>nav.NavigateTo("/requests"))">
                <span>📬</span>
                <span>Requests</span>
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/students"))">
                <span>👥</span>
                <span>Students</span>
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/profile-teacher"))">
                <span>⚙️</span>
                <span>Settings</span>
            </button>
            <button class="sidebar-item" @onclick="@(()=>nav.NavigateTo("/notifications-teacher"))">
                <span>🔔</span>
                <span>Notifications</span>
            </button>
        </div>
    </aside>

    <div class="main-container">
        <main class="main-content">
            <div class="header">
                <div>
                    <h1 class="greeting">Welcome back, @teacherName!</h1>
                    <p class="greeting-sub">Here's what's happening with your students today</p>
                </div>
                <div class="header-actions">
                    <button class="logout-btn" @onclick="Logout">Logout</button>
                    <div class="user-avatar">@GetInitials(teacherName)</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon green">✓</div>
                    <div class="stat-value">@GetCompletedTodayCount()</div>
                    <div class="stat-label">Completed Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">👥</div>
                    <div class="stat-value">@GetStudentCount()</div>
                    <div class="stat-label">Active Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon blue">✓</div>
                    <div class="stat-value">@GetCompletedCount()</div>
                    <div class="stat-label">Total Completions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon red">⚠️</div>
                    <div class="stat-value">3</div>
                    <div class="stat-label">Need Attention</div>
                </div>
            </div>

            <div class="create-card">
                <div class="create-content">
                    <h2>Create a new quiz</h2>
                    <p>Build engaging quizzes for the students in minutes</p>
                </div>
                <button class="create-btn" @onclick="GoToCreateQuiz">
                    <span>➕</span>
                    <span>Create Quiz</span>
                </button>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Recent Quizzes</h2>
                    <span class="view-all" @onclick="@(()=>nav.NavigateTo("/my-quizzes"))">View all →</span>
                </div>

                @if (recentQuizzes == null)
                {
                    <div class="empty-state">
                        <div class="empty-icon">⏳</div>
                        <p>Loading your quizzes...</p>
                    </div>
                }
                else if (recentQuizzes.Count == 0)
                {
                    <div class="empty-state">
                        <div class="empty-icon">📚</div>
                        <p>No quizzes yet. Create your first one!</p>
                    </div>
                }
                else
                {
                    <div class="quiz-grid">
                        @foreach (var quiz in recentQuizzes.Take(4))
                        {
                            <div class="quiz-card" @onclick="@(()=>nav.NavigateTo($"/quiz-details/{quiz.QuizId}"))">
                                <div class="quiz-header">
                                    <div class="quiz-topic">@quiz.QuizName</div>
                                    <div class="quiz-badge">Active</div>
                                </div>
                                <div class="quiz-text">@quiz.Description</div>
                                <div class="quiz-meta">
                                    <span>📝 @(quiz.Questions?.Count ?? 0) questions</span>
                                    <span>📅 @quiz.CreatedAt.ToString("dd MMM")</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="widget">
                <div class="widget-header">
                    <h3 class="widget-title">Struggling Students</h3>
                    <div class="widget-badge">@strugglingStudents.Count</div>
                </div>
                @if (strugglingStudents.Count == 0)
                {
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        <p>🎉 All students are doing well!</p>
                    </div>
                }
                else
                {
                    @foreach (var student in strugglingStudents)
                    {
                        <div class="student-item" @onclick="@(()=>nav.NavigateTo($"/student-details/{student.StudentId}"))">
                            <div class="student-avatar">@GetInitials(student.StudentName)</div>
                            <div class="student-info">
                                <div class="student-name">@student.StudentName</div>
                                <div class="student-issue">@student.Issue</div>
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="widget">
                <div class="widget-header">
                    <h3 class="widget-title">Tutoring Requests</h3>
                    <div class="widget-badge" style="background: #eff6ff; color: #3b82f6;">2</div>
                </div>
                <div class="request-item">
                    <div class="request-date">
                        <div class="date-day">12</div>
                        <div class="date-month">NOV</div>
                    </div>
                    <div class="request-info">
                        <div class="request-student">Michael Chen</div>
                        <div class="request-subject">Math - Algebra help</div>
                        <div class="request-actions">
                            <button class="request-btn accept">Accept</button>
                            <button class="request-btn decline">Decline</button>
                        </div>
                    </div>
                </div>
                <div class="request-item">
                    <div class="request-date">
                        <div class="date-day">14</div>
                        <div class="date-month">NOV</div>
                    </div>
                    <div class="request-info">
                        <div class="request-student">Lisa Anderson</div>
                        <div class="request-subject">Physics - Mechanics</div>
                        <div class="request-actions">
                            <button class="request-btn accept">Accept</button>
                            <button class="request-btn decline">Decline</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="widget">
                <h3 class="widget-title">Top Performing Quizzes</h3>
                @if (topPerformingQuizzes.Count == 0)
                {
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        <p style="font-size: 32px; margin-bottom: 8px;">📊</p>
                        <p>No quiz data yet</p>
                    </div>
                }
                else
                {
                    @foreach (var quiz in topPerformingQuizzes)
                    {
                        <div class="quiz-stats-item" @onclick="@(()=>nav.NavigateTo($"/quiz-details/{quiz.QuizId}"))">
                            <div class="quiz-stat-info">
                                <div class="quiz-stat-name">@quiz.QuizName</div>
                                <div class="quiz-stat-meta">@quiz.Completions completions</div>
                            </div>
                            <div class="quiz-stat-score">
                                <div class="score-value">@quiz.AverageScore%</div>
                                <div class="score-label">Avg Score</div>
                            </div>
                        </div>
                    }
                }
            </div>
        </aside>
    </div>
</div>

@code {
    private string teacherName = "";
    private List<Quiz> recentQuizzes;
    private bool _initialized = false;
    private bool _checkingSession = true;
    private List<StrugglingStudent> strugglingStudents = new();
    private List<TopQuiz> topPerformingQuizzes = new();
    private int totalStudents = 0; 
    private int totalCompletions = 0;
    private int completedToday = 0;

    private int GetCompletedTodayCount() => completedToday;
    private class TopQuiz
    {
        public int QuizId { get; set; }
        public string QuizName { get; set; }
        public int Completions { get; set; }
        public int AverageScore { get; set; }
    }

    private async Task LoadTopPerformingQuizzesAsync(int teacherId)
    {
        try
        {
            var quizDb = new QuizDB();
            var teacherQuizzes = await quizDb.GetQuizzesByTeacherAsync(teacherId);

            if (teacherQuizzes.Count == 0) return;

            var resultDb = new ResultDB();
            var topQuizzesList = new List<TopQuiz>();

            foreach (var quiz in teacherQuizzes)
            {
                var results = await resultDb.GetAllQuizResultsAsync(quiz.QuizId);

                if (results.Count == 0) continue;
                var completions = results.Where(r => r.score > 0)
                                        .Select(r => r.student_id)
                                        .Distinct()
                                        .Count();
                var scores = results.Where(r => r.score > 0)
                                   .GroupBy(r => r.student_id)
                                   .Select(g => g.First().score)
                                   .ToList();

                int avgScore = scores.Count > 0 ? (int)scores.Average() : 0;

                if (completions > 0) 
                {
                    topQuizzesList.Add(new TopQuiz
                        {
                            QuizId = quiz.QuizId,
                            QuizName = quiz.QuizName,
                            Completions = completions,
                            AverageScore = avgScore
                        });
                }
            }
            topPerformingQuizzes = topQuizzesList
                .OrderByDescending(q => q.AverageScore)
                .ThenByDescending(q => q.Completions)
                .Take(3) // רק 3 חידונים מובילים
                .ToList();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading top performing quizzes: {ex.Message}");
        }
    }
    private class StrugglingStudent
    {
        public int StudentId { get; set; }
        public string StudentName { get; set; }
        public string Issue { get; set; }
        public int Score { get; set; }
    }

    private async Task LoadStrugglingStudentsAsync(int teacherId)
    {
        try
        {
            // שליפת כל החידונים של המורה
            var quizDb = new QuizDB();
            var teacherQuizzes = await quizDb.GetQuizzesByTeacherAsync(teacherId);

            var resultDb = new ResultDB();
            var customerDb = new CustomerDB();

            var studentIssues = new Dictionary<int, (string name, string issue, int score)>();

            foreach (var quiz in teacherQuizzes)
            {
                var results = await resultDb.GetAllQuizResultsAsync(quiz.QuizId);
                var groupedByStudent = results.GroupBy(r => r.student_id);

                foreach (var group in groupedByStudent)
                {
                    var studentId = group.Key;
                    var studentResults = group.ToList();
                    var score = studentResults.FirstOrDefault()?.score ?? 0;
                    if (score < 60 && score > 0)
                    {
                        if (!studentIssues.ContainsKey(studentId))
                        {
                            var student = await customerDb.SelectByPkAsync(studentId);
                            if (student != null)
                            {
                                string issue = score < 50 ?
                                    $"Failed {quiz.QuizName} - {score}%" :
                                    $"Low score in {quiz.QuizName} - {score}%";

                                studentIssues[studentId] = (student.FullName, issue, score);
                            }
                        }
                    }
                }
            }

            // המרה לרשימה
            strugglingStudents = studentIssues
                .Select(kvp => new StrugglingStudent
                    {
                        StudentId = kvp.Key,
                        StudentName = kvp.Value.name,
                        Issue = kvp.Value.issue,
                        Score = kvp.Value.score
                    })
                .OrderBy(s => s.Score) 
                .Take(3) // רק 3 ראשונים
                .ToList();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading struggling students: {ex.Message}");
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _initialized)
            return;

        _initialized = true;

        try
        {
            var result = await session.GetAsync<Customers>("user");

            if (result.Success && result.Value != null)
            {
                teacherName = result.Value.FullName;
                await LoadRecentQuizzesAsync(result.Value.user_id);
            }
            else
            {
                _checkingSession = false;
                StateHasChanged();
                return;
            }
        }
        catch
        {
            _checkingSession = false;
            StateHasChanged();
            return;
        }

        _checkingSession = false;
        StateHasChanged();
    }

    protected override void OnParametersSet()
    {

        if (_checkingSession) return;
        if (string.IsNullOrEmpty(teacherName))
        {
            nav.NavigateTo("/login");
        }
    }

    private async Task LoadRecentQuizzesAsync(int teacherId)
    {
        var db = new QuizDB(); 
        recentQuizzes = await db.GetQuizzesByTeacherAsync(teacherId);
        await LoadTeacherStatisticsAsync(teacherId);
        await LoadStrugglingStudentsAsync(teacherId);
        await LoadTopPerformingQuizzesAsync(teacherId);
    }

    private async Task Logout()
    {
        await session.DeleteAsync("user");
        nav.NavigateTo("/login", true);
    }

    private void GoToCreateQuiz()
    {
        nav.NavigateTo("/create-quiz");
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "T";
        var parts = name.Split(' ');
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name[0].ToString().ToUpper();
    }

    private int GetStudentCount() => totalStudents;
    private int GetCompletedCount() => totalCompletions;

    private int GetRandomStudentCount()
    {
        var random = new Random();
        return random.Next(8, 35);
    }
    private async Task LoadTeacherStatisticsAsync(int teacherId)
    {
        try
        {
            var quizDb = new QuizDB();
            var teacherQuizzes = await quizDb.GetQuizzesByTeacherAsync(teacherId);

            if (teacherQuizzes.Count == 0) return;

            var resultDb = new ResultDB();
            var uniqueStudents = new HashSet<int>();
            int completions = 0;
            var today = DateTime.Today;
            foreach (var quiz in teacherQuizzes)
            {
                var results = await resultDb.GetAllQuizResultsAsync(quiz.QuizId);

                completedToday += results.Where(r => r.score > 0 && r.answered_at.Date == today)
                                        .Select(r => r.student_id)
                                        .Distinct()
                                        .Count();
            }

            foreach (var quiz in teacherQuizzes)
            {
                var results = await resultDb.GetAllQuizResultsAsync(quiz.QuizId);

                if (results.Count > 0)
                {
                    var studentsInQuiz = results.Select(r => r.student_id).Distinct();
                    foreach (var studentId in studentsInQuiz)
                    {
                        uniqueStudents.Add(studentId);
                    }
                    completions += results.Where(r => r.score > 0)
                                         .Select(r => r.student_id)
                                         .Distinct()
                                         .Count();
                }
            }

            totalStudents = uniqueStudents.Count;
            totalCompletions = completions;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading teacher statistics: {ex.Message}");
        }
    }
}
